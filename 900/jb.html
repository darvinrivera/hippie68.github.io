<html>
<style>
    body {
        height: 100%;
        margin: 16px;
        overflow: hidden;
    }

    #container {
        border: 1px solid black;
        box-shadow: 0 0 16px rgba(0, 0, 0, 0.5);
        display: inline-block;
        font-size: large;
    }

    #title {
        font-weight: bold;
        padding: 8px;
    }

    #log_area {
        border: 1px solid black;
        border-style: solid none none;
        padding: 8px;
    }
</style>
<body>
<div id="container">
  <div id="title"></div>
  <div id="log_area"></div>
</div>
<script>
var payloadFileName = document.location.hash.substr(1);
var logArea = document.getElementById("log_area");

// Create info box.
{
    let title = document.getElementById("title");
    title.innerHTML = "Now jailbreaking with " + "\"" + payloadFileName + "\"";

    // Applies a color scheme.
    function setColors(background1, background2, highlight, border, text1, text2 = text1) {
        container.style.borderColor = border;
        title.style.backgroundColor = background1;
        title.style.borderColor = border;
        title.style.color = text1;
        logArea.style.backgroundColor = background2;
        logArea.style.borderColor = border;
        logArea.style.color = text2;
    }

    // Load color scheme.
    let color_scheme = localStorage.getItem("color_scheme");
    switch (color_scheme) {
        case "cappuccino":
            setColors("#3A2E2E", "#D6B79F", "sienna", "#816C61", "#F7ECDF", "#4B3832");
            break;
        case "dark":
            setColors("#333333", "#666666", "#444444", "#AAAAAA", "#DDDDDD");
            break;
        case "lavender":
            setColors("lavender", "#F5F5FA", "thistle", "darkorchid", "indigo");
            break;
        case "midnightblue":
            setColors("midnightblue", "royalblue", "tomato", "#A9BBF1", "white");
            break;
        case "pink":
            setColors("#934A70", "#BC7B9C", "#763C59", "#D8B2C5", "#F5ECF1");
            break;
        case "rojigualda":
            setColors("#AA151B", "#F1BF00", "#800F14", "#D7810A", "#F1BF00", "#AA151B");
            break;
        case "usa":
            setColors("#9B1C2C", "#33335F", "#33335F", "#CCC8BF", "#E3DED4");
            break;
        case "wheat":
            setColors("wheat", "#FFFBF2", "burlywood", "saddlebrown", "maroon");
            break;
        case "wildberry":
            setColors("#550000", "#AA3939", "#801515", "#E6C7C7", "#FFDDDD");
            break;
        default: // "gray"
            setColors("#F0F0F0", "white", "#D7D7D7", "gray", "black");
    }
}

function logMessage(message) {
    logArea.innerHTML += "[+] " + message + "<br>";
}

function print() {}

// Runs code from a single JavaScript file.
function runScript(script) {
    let xhr = new XMLHttpRequest();
    xhr.open("GET", script, false);
    xhr.send("");
    eval.call(window, xhr.responseText);
}

// Loads a file and returns its (decompressed) content as an Uint8Array.
function fileToArray(fileName) {
    let xhr = new XMLHttpRequest();
    xhr.open("GET", fileName, false);
    xhr.overrideMimeType("text/plain; charset=x-user-defined");
    xhr.send();
    let array = Uint8Array.from(xhr.response, c => c.charCodeAt(0));

    // Decompress file, if necessary.
    if (fileName.endsWith(".bz2")) {
        try {
            array = bzip2.simple(bzip2.array(array));
        } catch(error) {
            alert(fileName + ": \"" + error + "\"\nPlease report this critical bug at https://github.com/hippie68/hippie68.github.io/issues.");
            throw error;
        }
    }

    return array;
}

// Converts a payload file to JavaScript code, which is then run.
function runPayload(fileName) {
    if (fileName.endsWith(".js")) { // No conversion required.
        runScript(fileName);
        return;
    }

    let array = fileToArray(fileName);
    if (fileName.endsWith(".js.bz2")) { // array represents a .js file.
        let decoder = new TextDecoder();
        eval.call(window, decoder.decode(array));
    } else { // array represents a .bin file.
        eval.call(window, `window.mira_blob_2_len=${array.length};window.mira_blob_2=malloc(window.mira_blob_2_len);write_mem(window.mira_blob_2,[${array}]);\n`);
    }
}

// Runs after the kernel exploit.
function afterKernel() {
    runScript('common/relocator.js');

    // Load Web Activator's frontend.
    if (payloadFileName == "payloads/web_activator.bin") {
        runScript("payloads/web_activator_frontend.js");
    }

    history.pushState({}, "", ".");
    if (main_ret == 0 || main_ret == 179) {
        if (localStorage.getItem("disable_youreallset") != 1)
            alert("You're all set!");

        // Only return if Web Activator's frontend is not used.
        if (payloadFileName != "payloads/web_activator.bin")
            setTimeout(function() { read_ptr_at(0); }, 1);
    } else {
        alert("Jailbreak is not activated.");
    }
}

logMessage("Please wait...");

// Display additional information for certain payloads.
if (payloadFileName == "mira/jbcldr.js") {
    logMessage("Info: The netcat server uses port 9021");
} else if (payloadFileName == "payloads/ftp.bin") {
    logMessage("Info: The FTP server uses port 1337");
    logMessage("Info: Please send the custom FTP command \"SHUTDOWN\" when done");
    logMessage("Info: (for FileZilla: Server - Enter custom command...)");
}

setTimeout(function() {
    runScript("bzip2.js");
    runScript("netcat.js");
    runScript("webkit-9.00/exploit.js");
    runScript("webkit-9.00/malloc.js");
    runScript("webkit-9.00/rop/rop.js");
    runScript("common/syscalls.js");
    runScript("common/syscalls2.js");
    if (payloadFileName == "mira/mira2.js") {
        runPayload(payloadFileName);
        runScript("mira/mira.js");
    } else if (payloadFileName == "mira/jbcldr.js") { // Netcat
        runScript("mira/jbcldr.js");
    } else {
        runScript("mira/jbcldr.js");
        runPayload(payloadFileName);
    }
    runScript("kexploit/int64.js");
    runScript("kexploit/rop.js");
    runScript("kexploit/kexploit.js");
    runScript("kexploit-launcher.js");
}, 30);
</script>
</body>
</html>
